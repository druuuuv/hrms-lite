<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRMS Lite - V4 (Final Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const API_BASE = "/api"; 

        function App() {
            const [employees, setEmployees] = useState([]);
            const [attendanceRecords, setAttendanceRecords] = useState([]); 
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('list');
            const [formData, setFormData] = useState({ emp_id: '', name: '', email: '', department: '' });
            
            // Attendance Modal State
            const [attendanceData, setAttendanceData] = useState({ date: new Date().toISOString().split('T')[0], status: 'Present' });
            const [selectedEmp, setSelectedEmp] = useState(null);
            
            // History Modal State
            const [showHistory, setShowHistory] = useState(false);
            const [historyLogs, setHistoryLogs] = useState([]);
            const [historyEmp, setHistoryEmp] = useState(null); 

            const [error, setError] = useState('');

            useEffect(() => { fetchAllData(); }, []);

            const fetchAllData = async () => {
                try {
                    const [empRes, attRes] = await Promise.all([
                        axios.get(`${API_BASE}/employees/`),
                        axios.get(`${API_BASE}/attendance/`)
                    ]);
                    setEmployees(empRes.data);
                    setAttendanceRecords(attRes.data);
                    setLoading(false);
                    return attRes.data; 
                } catch (err) {
                    console.error("Fetch error:", err);
                    setLoading(false);
                    return [];
                }
            };

            const handleDelete = async (id) => {
                if(!confirm("Delete this employee?")) return;
                try {
                    await axios.delete(`${API_BASE}/employees/${id}/`);
                    fetchAllData();
                } catch(err) { alert("Error deleting."); }
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                setError('');

                // 1. Numeric ID Validation
                const isNumeric = /^\d+$/.test(formData.emp_id);
                if (!isNumeric) {
                    setError("Invalid ID: Please enter a numeric number only.");
                    return;
                }

                // 2. Gmail Validation
                if (!formData.email.toLowerCase().endsWith("@gmail.com")) {
                    setError("Invalid Email: Please enter a valid @gmail.com address.");
                    return;
                }

                try {
                    await axios.post(`${API_BASE}/employees/`, formData);
                    setFormData({ emp_id: '', name: '', email: '', department: '' });
                    setView('list');
                    fetchAllData();
                } catch (err) {
                    setError("Error: This ID or Email already exists in the system.");
                }
            };

            const handleMarkAttendance = async () => {
                try {
                    await axios.post(`${API_BASE}/attendance/`, {
                        employee: selectedEmp.id,
                        date: attendanceData.date,
                        status: attendanceData.status
                    });
                    alert("Attendance marked!");
                    setSelectedEmp(null);
                    fetchAllData(); 
                } catch (err) {
                    alert("Already marked for this date.");
                }
            };

            const openHistory = (emp) => {
                const logs = attendanceRecords.filter(r => r.employee === emp.id);
                logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                setHistoryLogs(logs);
                setHistoryEmp(emp);
                setShowHistory(true);
            };

            const handleToggleStatus = async (log) => {
                const newStatus = log.status === 'Present' ? 'Absent' : 'Present';
                try {
                    await axios.patch(`${API_BASE}/attendance/${log.id}/`, { status: newStatus });
                    const newRecords = await fetchAllData();
                    
                    if (historyEmp) {
                        const updatedLogs = newRecords.filter(r => r.employee === historyEmp.id);
                        updatedLogs.sort((a, b) => new Date(b.date) - new Date(a.date));
                        setHistoryLogs(updatedLogs);
                    }

                } catch (err) {
                    alert("Error updating status. Please try again.");
                }
            };

            return (
                <div className="min-h-screen p-8 max-w-5xl mx-auto font-sans">
                    <header className="flex justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div>
                            <h1 className="text-3xl font-bold text-gray-800 tracking-tight">HRMS Lite</h1>
                            <p className="text-gray-500 text-sm">Real-time Attendance Dashboard</p>
                        </div>
                        <button 
                            onClick={() => { setView(view === 'list' ? 'add' : 'list'); setError(''); }} 
                            className="bg-blue-600 text-white px-6 py-2.5 rounded-lg hover:bg-blue-700 transition font-medium shadow-sm flex items-center gap-2"
                        >
                            {view === 'list' ? <span>+ Add Employee</span> : <span>Back to List</span>}
                        </button>
                    </header>

                    {view === 'add' && (
                        <div className="bg-white p-8 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto border border-gray-100 fade-in">
                            <h2 className="text-xl font-bold mb-6 text-gray-800">New Employee</h2>
                            {error && <div className="bg-red-50 text-red-600 p-3 rounded mb-4 text-sm font-medium border border-red-100">{error}</div>}
                            <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-2 gap-5">
                                <input placeholder="Numeric ID" className="border p-2 rounded" value={formData.emp_id} onChange={e => setFormData({...formData, emp_id: e.target.value})} required />
                                <input placeholder="Full Name" className="border p-2 rounded" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} required />
                                <input placeholder="Gmail Address" type="email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} required />
                                <input placeholder="Department" className="border p-2 rounded" value={formData.department} onChange={e => setFormData({...formData, department: e.target.value})} required />
                                <button type="submit" className="bg-gray-900 text-white py-3 rounded col-span-2 hover:bg-black transition font-bold tracking-wide">Save Record</button>
                            </form>
                        </div>
                    )}

                    {loading ? <div className="text-center py-20 text-gray-500">Loading records...</div> : (
                        <div className="grid gap-4">
                            {employees.map(emp => {
                                const today = new Date().toISOString().split('T')[0];
                                const record = attendanceRecords.find(r => r.employee === emp.id && r.date === today);
                                
                                const indicatorColor = record 
                                    ? (record.status === 'Present' ? 'bg-green-500' : 'bg-red-500') 
                                    : 'bg-gray-300';
                                
                                const borderStyle = record 
                                    ? (record.status === 'Present' ? 'border-l-green-500' : 'border-l-red-500') 
                                    : 'border-l-gray-200';

                                return (
                                    <div key={emp.id} className={`bg-white p-5 rounded-xl shadow-sm border-l-4 ${borderStyle} flex justify-between items-center hover:shadow-md transition fade-in`}>
                                        <div className="flex items-center gap-4">
                                            <div className={`${indicatorColor} text-white w-10 h-10 rounded-full flex items-center justify-center font-bold shadow-sm`}>
                                                {emp.name.charAt(0)}
                                            </div>
                                            <div>
                                                <h3 className="font-bold text-lg text-gray-800">{emp.name} 
                                                    {record && <span className={`ml-2 text-xs px-2 py-0.5 rounded-full ${record.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{record.status}</span>}
                                                </h3>
                                                <p className="text-sm text-gray-500">ID: {emp.emp_id} â€¢ {emp.department}</p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => openHistory(emp)}
                                                className="bg-white border border-gray-200 text-gray-600 px-3 py-2 rounded-lg text-sm hover:bg-gray-50 transition"
                                                title="View History"
                                            >
                                                <i className="fa-solid fa-clock-rotate-left"></i>
                                            </button>
                                            <button 
                                                onClick={() => setSelectedEmp(emp)} 
                                                className="bg-gray-50 border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm hover:bg-blue-50 hover:text-blue-600 transition font-medium"
                                            >
                                                Mark
                                            </button>
                                            <button onClick={() => handleDelete(emp.id)} className="text-gray-300 hover:text-red-600 p-2 transition">
                                                <i className="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {selectedEmp && (
                        <div className="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center fade-in z-50">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-96">
                                <h3 className="text-xl font-bold mb-4">Mark Attendance</h3>
                                <p className="mb-6 text-gray-600 bg-gray-50 p-3 rounded font-medium">{selectedEmp.name}</p>
                                <input type="date" className="border p-2 w-full mb-4 rounded" value={attendanceData.date} onChange={e => setAttendanceData({...attendanceData, date: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2 mb-6">
                                    <button onClick={() => setAttendanceData({...attendanceData, status: 'Present'})} className={`py-3 rounded-lg border font-medium transition ${attendanceData.status === 'Present' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-600'}`}>Present</button>
                                    <button onClick={() => setAttendanceData({...attendanceData, status: 'Absent'})} className={`py-3 rounded-lg border font-medium transition ${attendanceData.status === 'Absent' ? 'bg-red-600 text-white border-red-600' : 'bg-gray-200 text-gray-600'}`}>Absent</button>
                                </div>
                                <button onClick={handleMarkAttendance} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Confirm Status</button>
                                <button onClick={() => setSelectedEmp(null)} className="w-full mt-2 text-gray-400 text-sm">Cancel</button>
                            </div>
                        </div>
                    )}

                    {showHistory && (
                        <div className="fixed inset-0 bg-gray-900/50 backdrop-blur-sm flex items-center justify-center fade-in z-50">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-bold">Attendance History</h3>
                                    <button onClick={() => setShowHistory(false)} className="text-gray-400 hover:text-gray-600"><i className="fa-solid fa-times"></i></button>
                                </div>
                                <p className="mb-4 text-blue-600 font-medium bg-blue-50 p-2 rounded inline-block">
                                    {historyEmp ? historyEmp.name : ''}
                                </p>
                                
                                <div className="max-h-60 overflow-y-auto border rounded-lg">
                                    {historyLogs.length === 0 ? (
                                        <div className="p-4 text-center text-gray-500">No records found.</div>
                                    ) : (
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-700 font-bold sticky top-0">
                                                <tr>
                                                    <th className="p-3 border-b">Date</th>
                                                    <th className="p-3 border-b">Status</th>
                                                    <th className="p-3 border-b text-center">Edit</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {historyLogs.map((log, idx) => (
                                                    <tr key={idx} className="border-b last:border-0 hover:bg-gray-50 transition">
                                                        <td className="p-3 font-mono text-gray-600">{log.date}</td>
                                                        <td className="p-3">
                                                            <span className={`px-2 py-1 rounded-full text-xs font-bold ${log.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                                {log.status}
                                                            </span>
                                                        </td>
                                                        <td className="p-3 text-center">
                                                            <button 
                                                                onClick={() => handleToggleStatus(log)}
                                                                className="text-gray-400 hover:text-blue-600 p-1 rounded hover:bg-blue-50 transition"
                                                                title="Click to toggle status"
                                                            >
                                                                <i className="fa-solid fa-pen-to-square"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    )}
                                </div>
                                <button onClick={() => setShowHistory(false)} className="w-full mt-6 bg-gray-100 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-200 transition">Close</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>